<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auto Usado - Info</title>
        <!-- Metadatos para compartir -->
    <meta property="og:title" content="Auto Usado en Venta" id="ogTitle">
    <meta property="og:description" content="Información detallada del vehículo" id="ogDescription">
    <meta property="og:image" content="" id="ogImage">
    <meta property="og:url" content="" id="ogUrl">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@latest/dist/umd/supabase.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/swiper/swiper-bundle.min.css" />
    <script src="https://unpkg.com/swiper/swiper-bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
   <style>
              body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-width: 800px;
            margin: 16px auto;
        }
        .interaction-icon {
            width: 24px;
            height: 24px;
            stroke: #4b5563;
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        .custom-input {
            border: 1px solid #d1d5db;
            border-radius: 6px;
            padding: 0.75rem;
            font-size: 0.875rem;
            transition: border-color 0.3s ease;
        }
        .custom-input:focus {
            border-color: #3b82f6;
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .custom-button {
            background-color: #3b82f6;
            color: white;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            transition: background-color 0.3s ease, transform 0.1s ease;
        }
        .custom-button:hover {
            background-color: #2563eb;
            transform: translateY(-1px);
        }
        .custom-button:active {
            transform: translateY(0);
        }
        .discount-banner {
            background: linear-gradient(45deg, #4f46e5, #3b82f6);
            border-radius: 8px;
            padding: 1.5rem;
            margin-top: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .swiper-container {
            padding: 32px 0;
            overflow: visible;
        }
        .swiper-slide {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border-radius: 8px;
            overflow: hidden;
        }
        .swiper-slide:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
        }
        .swiper-pagination-bullet-active {
            background-color: #3b82f6;
        }
        .swiper-button-next,
        .swiper-button-prev {
            color: #3b82f6;
            background-color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .swiper-button-next:after,
        .swiper-button-prev:after {
            font-size: 18px;
        }
        .vehicle-preview {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
.vehicle-preview-content {
    background-color: white;
    padding: 2rem;
    border-radius: 12px;
    max-width: 50%;
    max-height: 90%;
    overflow-y: auto;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
}

/* Estilos para pantallas pequeñas */
@media (max-width: 600px) {
    .vehicle-preview-content {
        padding: 1rem;
        max-width: 90%;
        max-height: 100%;
    }
}

/* Estilos para pantallas medianas */
@media (min-width: 601px) and (max-width: 1024px) {
    .vehicle-preview-content {
        padding: 1.5rem;
        max-width: 95%;
        max-height: 95%;
    }
}

        .close-preview {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 1.5rem;
            color: white;
            cursor: pointer;
            background-color: rgba(0, 0, 0, 0.5);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background-color 0.3s ease;
        }
        .close-preview:hover {
            background-color: rgba(0, 0, 0, 0.7);
        }
        .swiper-container {
            padding: 32px 0;
            overflow: hidden;
            position: relative;
        }
        .swiper-slide {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border-radius: 8px;
            overflow: hidden;
        }
        .swiper-slide:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
        }
        .swiper-button-next,
        .swiper-button-prev {
            color: #3b82f6;
            background-color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            top: 50%;
        }
        .swiper-button-next:after,
        .swiper-button-prev:after {
            font-size: 18px;
        }
        .dynamic-banner {
            background: linear-gradient(45deg, #4f46e5, #3b82f6);
            color: white;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-weight: 600;
            text-align: center;
        }
        .swiper-container {
            padding: 32px 0;
            overflow: hidden;
            position: relative;
        }
        .swiper-slide {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border-radius: 8px;
            overflow: hidden;
        }
        .swiper-slide:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
        }
        .swiper-button-next,
        .swiper-button-prev {
            color: #3b82f6;
            background-color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            top: 50%;
        }
        .swiper-button-next:after,
        .swiper-button-prev:after {
            font-size: 18px;
        }
        .dynamic-banner {
            background: linear-gradient(45deg, #4f46e5, #3b82f6);
            color: white;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-weight: 600;
            text-align: center;
        }
        .gallery-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
        }
        .gallery-image {
            width: calc(33.333% - 10px);
            object-fit: cover;
            border-radius: 4px;
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        .gallery-image:hover {
            transform: scale(1.05);
        }
        .modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: var(--modal-background);
    opacity: 0;
    transition: opacity 0.3s ease;
}

.modal.show {
    display: flex;
    opacity: 1;
}

.modal-content {
    background-color: #fff;
    margin: auto;
    padding: 2rem;
    border-radius: 8px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    width: 90%;
    max-width: 800px;
    transform: scale(0.9);
    transition: transform 0.3s ease;
}

.modal.show .modal-content {
    transform: scale(1);
}

.close {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    background: none;
    border: none;
    padding: 0;
}

.close:hover,
.close:focus {
    color: #000;
    text-decoration: none;
}

.gallery-container {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.gallery-image {
    width: 100%;
    height: 150px;
    object-fit: cover;
    border-radius: 4px;
    cursor: pointer;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.gallery-image:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}

.vehicle-info {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.info-item {
    background-color: #fff;
    padding: 1rem;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.info-label {
    font-weight: bold;
    color: var(--primary-color);
    margin-bottom: 0.5rem;
    display: block;
}

.share-button {
    background-color: #27ae60;
    color: white;
    border: none;
    padding: 0.75rem 1.5rem;
    font-size: 1rem;
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background-color 0.3s ease, transform 0.3s ease;
    width: 100%;
}

.share-button:hover {
    background-color: #27ae60;
    transform: translateY(-2px);
}

.share-button i {
    margin-right: 0.5rem;
}

.dynamic-banner {
    text-align: center;
    padding: 1rem;
    margin-bottom: 1.5rem;
    border-radius: 4px;
    font-weight: bold;
    transition: background-color 0.3s ease;
}

@media (max-width: 768px) {
    .modal-content {
        padding: 1rem;
    }

    .gallery-container {
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
    }

    .gallery-image {
        height: 100px;
    }
}
    </style>
</head>
<body class="bg-gray-100 min-h-screen py-8">
    <div class="max-w-2xl mx-auto px-4">
        <div class="card mb-8">
            <div class="p-4 border-b border-gray-200">
                <h1 class="text-xl font-semibold text-gray-900">Información del Vehículo</h1>
            </div>
            <div id="vehiculoInfo" class="p-4">
                <!-- Vehicle information will be loaded here -->
            </div>
            <div id="vehiculoImagenes" class="grid grid-cols-3 gap-1 p-1">
                <!-- Vehicle images will be loaded here -->
            </div>
            <div class="p-4 flex items-center justify-between border-t border-gray-200">
                <div class="flex items-center space-x-4">
                    <button id="meInteresaBtn" class="flex items-center space-x-1 custom-button w-full flex items-center justify-center">
                        <!--i data-feather="heart" class="interaction-icon"></i-->
                        <span class="text-sm font-medium">Me interesa</span>
                    </button>
                    <div class="flex items-center space-x-1">
                        <i data-feather="eye" class="interaction-icon"></i>
                        <span id="viewCount" class="text-sm font-medium">0</span>
                    </div>
                </div>
              <div class="flex items-center space-x-1 cursor-pointer" id="interestedUsersBtn">
                    <i data-feather="users" class="interaction-icon"></i>
                    Interesados
                    <span id="interestedUsersCount" class="text-sm font-medium">0</span>
                </div>
            </div>
            <div id="interesadosModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
                <div class="bg-white p-6 rounded-lg max-w-md w-full max-h-[80vh] overflow-auto">
                    <h2 class="text-2xl font-bold mb-4">Usuarios Interesados</h2>
                    <div id="interesadosLista" class="mb-4"></div>
                    <button id="cerrarModalBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">
                        Cerrar
                    </button>
                </div>
            </div>
                
            <div id="interesadosContainer" class="p-4 border-t border-gray-200 hidden"></div>
            <div class="p-4 border-t border-gray-200">
                <h3 class="font-semibold mb-2" id="ic">Información de Cuotas</h3>
                <div id="cuotasInfo">
                    <p class="text-sm text-gray-600">Cantidad de Cuotas: <span id="cantidadCuotasDisplay" class="font-medium"></span></p>
                    <p class="text-sm text-gray-600">Valor de la Cuota: $<span id="valorCuotasDisplay" class="font-medium"></span></p>
                </div>
                <p id="reservadoInfo" class="text-sm text-green-600 font-semibold hidden">Reservado</p>
            </div>
        </div>

        <div id="vehiculoSenado" class="card p-4 mb-8 hidden bg-yellow-100 text-yellow-800">
            <p class="font-semibold">¡Hay interesados por este vehículo!</p>
            <p class="font-semibold">¡Reservalo abonando la suscripción!</p>
        </div>

        <div id="vehiculoSenadoa" class="card p-4 mb-8 hidden bg-blue-100 text-blue-800">
            <p class="font-semibold">¡Reservalo abonando la suscripción!</p>
        </div>

        <div id="customInstructions" class="card p-4 mb-8 hidden">
            <h4 class="font-semibold mb-2">Instrucciones para Reservar:</h4>
            <ol class="list-decimal pl-5 text-sm text-gray-600 space-y-1">
                <li>Complete el formulario con sus datos personales.</li>
                <li>Revise la información de las cuotas y términos de pago.</li>
                <li>Adjunte una copia de su DNI (frente y dorso).</li>
                <li>Envíe el formulario y espere la confirmación.</li>
            </ol>
        </div>

        <div id="formContainer" class="card p-4 hidden">
            <form id="autoUsadoForm" class="space-y-4">
                <div>
                    <label for="vehiculoIngreso" class="block text-sm font-medium text-gray-700 mb-1">Vehículo</label>
                    <input type="text" id="vehiculoIngreso" name="vehiculoIngreso" required class="custom-input w-full" readonly>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="cantidadCuotas" class="block text-sm font-medium text-gray-700 mb-1">Cantidad de Cuotas</label>
                        <input type="number" id="cantidadCuotas" name="cantidadCuotas" required class="custom-input w-full" readonly>
                    </div>
                    <div>
                        <label for="valorCuotas" class="block text-sm font-medium text-gray-700 mb-1">Valor de las Cuotas</label>
                        <input type="number" id="valorCuotas" name="valorCuotas" required class="custom-input w-full" readonly>
                    </div>
                </div>
                <div id="discountBanner" class="discount-banner">
                    <h3 class="text-lg font-semibold mb-2 flex items-center">
                        <i data-feather="tag" class="mr-2"></i>
                        ¡Oferta Especial!
                    </h3>
                    <p class="text-sm">
                        50% de descuento en la suscripción. ¡Pague solo $50.000 en lugar de $100.000!
                    </p>
                </div>
                <p class="text-sm text-gray-600">La suscripción es el gasto administrativo para gestionar la carpeta y emitir los papeles.</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="nombre" class="block text-sm font-medium text-gray-700 mb-1">Nombre</label>
                        <input type="text" id="nombre" name="nombre" required class="custom-input w-full">
                    </div>
                    <div>
                        <label for="apellido" class="block text-sm font-medium text-gray-700 mb-1">Apellido</label>
                        <input type="text" id="apellido" name="apellido" required class="custom-input w-full">
                    </div>
                </div>
                <div>
                    <label for="numeroDocumento" class="block text-sm font-medium text-gray-700 mb-1">Número de Documento</label>
                    <input type="text" id="numeroDocumento" name="numeroDocumento" required class="custom-input w-full">
                </div>
                <div>
                    <label for="celular" class="block text-sm font-medium text-gray-700 mb-1">Número de Celular</label>
                    <input type="tel" id="celular" name="celular" required class="custom-input w-full">
                </div>
                <div>
                    <label for="fechaPago" class="block text-sm font-medium text-gray-700 mb-1">Fecha de Pago de la Suscripción</label>
                    <input type="date" id="fechaPago" name="fechaPago" required class="custom-input w-full">
                </div>
                <div>
                    <label for="metodoPago" class="block text-sm font-medium text-gray-700 mb-1">Método de Pago de las Cuotas</label>
                    <select id="metodoPago" name="metodoPago" required class="custom-input w-full">
                        <option value="">Seleccione un método de pago</option>
                        <option value="efectivo">Efectivo</option>
                        <option value="transferencia">Transferencia</option>
                        <option value="tarjeta">Tarjeta</option>
                    </select>
                </div>
                <div>
                    <label for="frontImage" class="block text-sm font-medium text-gray-700 mb-1">DNI Frente</label>
                    <input type="file" id="frontImage" name="frontImage" accept="image/*" required class="custom-input w-full">
                </div>
                <div>
                    <label for="backImage" class="block text-sm font-medium text-gray-700 mb-1">DNI Dorso</label>
                    <input type="file" id="backImage" name="backImage" accept="image/*" required class="custom-input w-full">
                </div>
                <button type="submit" id="submitButton" class="custom-button w-full flex items-center justify-center">
                    <i data-feather="send" class="mr-2"></i>
                    Enviar Formulario
                </button>
            </form>
        </div>

        <div id="successBanner" class="card p-4 hidden">
            <h2 class="text-xl font-semibold text-green-600 mb-2">¡Felicitaciones por la compra de su auto usado!</h2>
            <p class="text-sm text-gray-600 mb-2">Su solicitud ha sido enviada con éxito. Nos pondremos en contacto con usted pronto para finalizar los detalles de su compra.</p>
            <p class="text-sm text-gray-600 mb-2">El método de Pago enviado es para abonar la suscripción de $50.000 y finalizar la carpeta <span id="codigoCliente" class="font-bold"></span></p>
            <div id="paymentInfo" class="mt-4 text-sm text-gray-600"></div>
        </div>

        <div class="max-w-4xl mx-auto px-4 mb-8">
            <div class="swiper-container">
                <div class="p-4 border-b border-gray-200">
                    <h1 class="text-xl font-semibold text-gray-900">Vehículos</h1>
                </div>
                <div class="swiper-wrapper">
                    <!-- Carousel items will be dynamically added here -->
                </div>
                <div class="swiper-pagination"></div>
                <div class="swiper-button-next"></div>
                <div class="swiper-button-prev"></div>
            </div>
        </div>
    
        <div id="vehiclePreview" class="vehicle-preview" style="display: none;">
            <div class="vehicle-preview-content">
                <span class="close-preview">&times;</span>
                <div id="previewContent"></div>
            </div>
        </div>

        <div class="card p-4 mt-8" style="margin-top: 36px;">
            <h2 class="text-xl font-semibold mb-4">Seguimiento del Plan</h2>
            <form id="validationForm" class="space-y-4">
                <div>
                    <label for="codigoValidacion" class="block text-sm font-medium text-gray-700 mb-1">Número de Documento del cliente</label>
                    <input type="text" id="codigoValidacion" name="codigoValidacion" required class="custom-input w-full">
                </div>
                <button type="submit" class="custom-button w-full flex items-center justify-center">
                    <i data-feather="check" class="mr-2"></i>
                    Validar Información
                </button>
            </form>
            <div id="clientInfo" class="mt-6 hidden">
                <div id="clientInfoContent" class="bg-gray-100 p-4 rounded-lg"></div>
                <div id="comprobantePagoSection" class="mt-4 hidden">
                    <h3 class="text-lg font-semibold mb-2">Cargar Comprobante de Pago</h3>
                    <form id="comprobantePagoForm" class="space-y-4">
                        <div>
                            <label for="comprobantePago" class="block text-sm font-medium text-gray-700 mb-1">Comprobante de Pago</label>
                            <input type="file" id="comprobantePago" name="comprobantePago" accept="image/*,.pdf" required class="custom-input w-full">
                        </div>
                        <button type="submit" id="enviarComprobanteBtn" class="custom-button w-full flex items-center justify-center">
                            <i data-feather="upload" class="mr-2"></i>
                            Enviar Comprobante
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div id="imageModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white p-2 rounded-lg max-w-3xl max-h-full overflow-auto">
            <img id="modalImage" src="" alt="Imagen ampliada" class="max-w-full h-auto">
        </div>
    </div>

    <div id="imageModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
       <div class="bg-white p-2 rounded-lg max-w-3xl max-h-full overflow-auto">
            <img id="modalImage" src="" alt="Imagen ampliada" class="max-w-full h-auto">
        </div>
    </div>
    
    <footer class="mt-8 text-center text-sm text-gray-500">
        
        <p>© 2024 Todos los derechos reservados.</p>
    </footer>

    <script src="clientData.js"></script>
    <script>
        // Initialize EmailJS
        (function() {
            emailjs.init("faltEzcRORMdZCWYV");
        })();
    
        // Initialize Feather Icons
        feather.replace();
    
        async function almacenarImagenEnImgBB(imageFile, side) {
            const formData = new FormData();
            formData.append("image", imageFile);

            try {
                const response = await fetch("https://api.imgbb.com/1/upload?key=1546c299417598ed2635d567ce946b2b", {
                    method: "POST",
                    body: formData,
                });
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                console.log(`Imagen ${side} cargada:`, data);
                return data.data.display_url;
            } catch (error) {
                console.error('Error al cargar la imagen:', error);
                throw error;
            }
        }
    
function desencriptarEnlace(enlaceEncriptado) {
    const claveSecreta = 'clave-secreta'; // Debes usar la misma clave secreta utilizada para encriptar
    const bytes = CryptoJS.AES.decrypt(enlaceEncriptado, claveSecreta);
    const enlaceDesencriptado = bytes.toString(CryptoJS.enc.Utf8);
    return enlaceDesencriptado;
}

async function cargarEnlace() {
    const enlaceEncriptado = getUrlParameter('vehiculo'); // Cambia 'enlace' a 'vehiculo'
    if (enlaceEncriptado) {
        const enlaceDesencriptado = desencriptarEnlace(enlaceEncriptado);
        console.log('Enlace desencriptado:', enlaceDesencriptado);
        
        // Asegurarnos de que el enlace desencriptado contiene el ID del vehículo
        const url = new URL(enlaceDesencriptado);
        const vehiculoId = url.searchParams.get('vehiculo');
        
        console.log('ID del vehículo extraído:', vehiculoId);
        if (vehiculoId && !isNaN(vehiculoId)) {
            // Aquí puedes redirigir o hacer lo que necesites con el ID del vehículo
            await cargarInformacionVehiculo(vehiculoId);
            // await mostrarInteresados(vehiculoId);// Cargar información usando el ID
        } else {
            console.error('ID del vehículo no válido:', vehiculoId);
        }
    }
}

document.addEventListener('DOMContentLoaded', (event) => {
    cargarEnlace();
});

// Function to get URL parameters
function getUrlParameter(name) {
    name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
    var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
    var results = regex.exec(location.search);
    return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
}


// Function to load vehicle information
async function cargarInformacionVehiculo(vehiculoId) { // Agregamos vehiculoId como parámetro
    if (vehiculoId) {
        try {
            const { data: vehiculoData, error: vehiculoError } = await supabaseClient
                .from('vehiculos')
                .select('*')
                .eq('id', vehiculoId) // Usamos vehiculoId aquí
                .single();

            if (vehiculoError) throw vehiculoError;

            if (vehiculoData) {
                console.log('Datos del vehículo:', vehiculoData); // Para depuración

                const { count, error } = await supabaseClient
                            .from('interested_users')
                            .select('*', { count: 'exact' })
                            .eq('vehiculo_id', vehiculoId);

                        if (error) throw error;

                        const cuotasInfo = document.getElementById('cuotasInfo');
                        const reservadoInfo = document.getElementById('reservadoInfo');
                        const ic = document.getElementById('ic');

                        if (count > 0) {
                            // Hide cuotas info and show "Reservado"
                            ic.classList.add('hidden');
                            cuotasInfo.classList.add('hidden');
                            reservadoInfo.classList.remove('hidden');
                        } else {
                            // Show cuotas info and hide "Reservado"
                            cuotasInfo.classList.remove('hidden');
                            reservadoInfo.classList.add('hidden');
                            document.getElementById('cantidadCuotasDisplay').textContent = vehiculoData.cantidad_cuota;
                            document.getElementById('valorCuotasDisplay').textContent = vehiculoData.valor_cuota;
                        }

                // Update metadata
                document.getElementById('ogTitle').setAttribute('content', `${vehiculoData.vehiculo_ingreso} en venta`);
                document.getElementById('ogDescription').setAttribute('content', `${vehiculoData.modelo} - ${vehiculoData.kilometraje} km - ${vehiculoData.ficha_tecnica}`);
                document.getElementById('ogUrl').setAttribute('content', window.location.href);
            
                // Mostrar información del vehículo
                const vehiculoInfo = document.getElementById('vehiculoInfo');
                vehiculoInfo.innerHTML = `
                    <h2 class="text-2xl font-bold mb-2">${vehiculoData.vehiculo_ingreso}</h2>
                    <p class="text-gray-600 mb-1"><strong>Modelo:</strong> ${vehiculoData.modelo}</p>
                    <p class="text-gray-600 mb-1"><strong>Kilometraje:</strong> ${vehiculoData.kilometraje} km</p>
                    <p class="text-gray-600 mb-2"><strong>Ficha Técnica:</strong></p>
                    <p class="text-sm text-gray-500">${vehiculoData.ficha_tecnica}</p>
                `;

                // Mostrar imágenes
                const imagenesContainer = document.getElementById('vehiculoImagenes');
                imagenesContainer.innerHTML = '';
                vehiculoData.fotos.forEach((url, index) => {
                    const img = document.createElement('img');
                    img.src = url;
                    img.alt = `Imagen ${index + 1} del vehículo`;
                    img.classList.add('w-full', 'h-40', 'object-cover', 'cursor-pointer');
                    img.onclick = () => openModal(url);
                    imagenesContainer.appendChild(img);

                    // Set the first image as metadata for sharing
                    if (index === 0) {
                        document.getElementById('ogImage').setAttribute('content', url);
                    }
                });

                // Actualizar campos del formulario
                document.getElementById('vehiculoIngreso').value = vehiculoData.vehiculo_ingreso;
                document.getElementById('cantidadCuotas').value = vehiculoData.cantidad_cuota;
                document.getElementById('valorCuotas').value = vehiculoData.valor_cuota;
                document.getElementById('cantidadCuotasDisplay').textContent = vehiculoData.cantidad_cuota;
                document.getElementById('valorCuotasDisplay').textContent = vehiculoData.valor_cuota;

                // Almacenar la vista y actualizar el contador
                const newViewCount = await window.actualizarVistasVehiculo(vehiculoId);
                document.getElementById('viewCount').textContent = newViewCount;

                // Actualizar el contador de usuarios interesados
                await updateInterestedUsersCount(vehiculoId);
            }
        } catch (error) {
            console.error('Error al cargar la información del vehículo:', error);
        }
    }
}


    
        // Function to open image modal
        function openModal(imgSrc) {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            modalImg.src = imgSrc;
        }
    
        // Close modal when clicking outside the image
        document.getElementById('imageModal').addEventListener('click', function(e) {
            if (e.target === this) {
                this.classList.add('hidden');
                this.classList.remove('flex');
            }
        });


async function mostrarInteresados(vehiculoId) {
    try {
        const { data, error } = await supabaseClient
            .from('interested_users')
            .select('name')
            .eq('vehiculo_id', vehiculoId);

        if (error) throw error;

        const interesadosLista = document.getElementById('interesadosLista');
        interesadosLista.innerHTML = '';

        if (data.length > 0) {
            const lista = document.createElement('ul');
            lista.className = 'list-disc pl-5';
            data.forEach(usuario => {
                const item = document.createElement('li');
                item.textContent = usuario.name;
                item.className = 'mb-2';
                lista.appendChild(item);
            });
            interesadosLista.appendChild(lista);
        } else {
            interesadosLista.innerHTML = '<p>No hay usuarios interesados aún.</p>';
        }

        document.getElementById('interesadosModal').classList.remove('hidden');
        document.getElementById('interesadosModal').classList.add('flex');
    } catch (error) {
        console.error('Error al obtener los usuarios interesados:', error);
        alert('Error al cargar los usuarios interesados. Por favor, intente nuevamente.');
    }
}

// Evento para cerrar el modal
document.getElementById('cerrarModalBtn').addEventListener('click', function() {
    document.getElementById('interesadosModal').classList.add('hidden');
    document.getElementById('interesadosModal').classList.remove('flex');
});

// Cerrar el modal si se hace clic fuera de él
document.getElementById('interesadosModal').addEventListener('click', function(e) {
    if (e.target === this) {
        this.classList.add('hidden');
        this.classList.remove('flex');
    }
});
    
        // Function to update interested users count
  
        document.getElementById('interestedUsersBtn').addEventListener('click', async function() {
    const vehiculoEncriptado = getUrlParameter('vehiculo'); // Suponiendo que esta función obtiene el parámetro encriptado de la URL

    if (vehiculoEncriptado) {
        try {
            // Desencriptar el ID del vehículo
            const vehiculoDesencriptado = desencriptarEnlace(vehiculoEncriptado); // Reemplaza esto con tu lógica de desencriptación
            const vehiculoId = new URL(vehiculoDesencriptado).searchParams.get('id'); // Extraer ID

            if (vehiculoId && !isNaN(vehiculoId)) {
                // Convertir vehiculoId a número entero
                await mostrarInteresados(parseInt(vehiculoId)); // Llama a la función con el ID correcto
            } else {
                console.error('ID del vehículo no válido:', vehiculoId);
            }
        } catch (error) {
            console.error('Error al desencriptar el ID del vehículo:', error);
            alert('No se pudo cargar los interesados. Inténtalo de nuevo más tarde.');
        }
    } else {
        console.error('No se encontró el ID del vehículo en la URL.');
    }
});

    
    
        // Event listener for "Me Interesa" button
        document.getElementById('meInteresaBtn').addEventListener('click', async function() {
            document.getElementById('customInstructions').classList.remove('hidden');
            document.getElementById('formContainer').classList.remove('hidden');
            this.classList.add('text-red-500');
        });
    
        // Function to send email
        async function enviarEmail(urlFrente, urlDorso, formData) {
            const templateParams = {
                from_name: "Documentos",
                message: `
                    Nombre: ${formData.nombre}
                    Apellido: ${formData.apellido}
                    Número de Documento: ${formData.numeroDocumento}
                    Número de Celular: ${formData.celular}
                    Vehículo de Ingreso: ${formData.vehiculoIngreso}
                    Cantidad de Cuotas: ${formData.cantidadCuotas}
                    Valor de las Cuotas: ${formData.valorCuotas}
                    Fecha de Pago: ${formData.fechaPago}
                    Método de Pago: ${formData.metodoPago}
                    URL DNI Frente: ${urlFrente}
                    URL DNI Dorso: ${urlDorso}
                `,
                ...formData
            };

            try {
                const response = await emailjs.send("service_jsj4ejn", "template_swfwkp9", templateParams);
                console.log("Correo electrónico enviado correctamente!", response);
                return response;
            } catch (error) {
                console.error("Error al enviar el correo electrónico:", error);
                throw error;
            }
        }
    
        // Function to send form
        async function enviarFormulario(formData, frontImage, backImage) {
    try {
        let urlFrente = null;
        let urlDorso = null;

        if (frontImage) {
            urlFrente = await almacenarImagenEnImgBB(frontImage, 'front');
        }
        if (backImage) {
            urlDorso = await almacenarImagenEnImgBB(backImage, 'back');
        }

        await enviarEmail(urlFrente, urlDorso, formData);

        const clienteData = await window.guardarDatosCliente(formData, urlFrente, urlDorso);

        if (!clienteData) {
            throw new Error('No se pudo guardar la información del cliente');
        }

        return { success: true, message: 'Formulario enviado con éxito', codigoCliente: clienteData.numero_documento };
    } catch (error) {
        console.error('Error al enviar el formulario:', error);
        throw error;
    }
}
        // Form submission handler
        document.getElementById('autoUsadoForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const submitButton = document.getElementById('submitButton');
    submitButton.disabled = true;
    submitButton.innerHTML = '<svg class="animate-spin h-5 w-5 mr-3" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Procesando';

    const formData = new FormData(this);
    const frontImage = document.getElementById('frontImage').files[0];
    const backImage = document.getElementById('backImage').files[0];

    try {
        const result = await enviarFormulario(Object.fromEntries(formData), frontImage, backImage);
        
        // Simular un retraso de 3 segundos
        await new Promise(resolve => setTimeout(resolve, 3000));
        
        document.getElementById('formContainer').classList.add('hidden');
        document.getElementById('successBanner').classList.remove('hidden');
        document.getElementById('codigoCliente').textContent = result.codigoCliente;

        // Mostrar información de pago específica
        const metodoPago = formData.get('metodoPago');
        const paymentInfo = document.getElementById('paymentInfo');
        switch (metodoPago) {
            case 'efectivo':
                paymentInfo.innerHTML = `
                    <p>Descargue el cupón de pago para abonar la suscripción:</p>
                    <a href="SUS50000.pdf" download="cupon_mundoauto.pdf" class="text-blue-600 font-bold py-2 px-4 mt-2 rounded hover:bg-blue-100 transition duration-300 inline-flex items-center">
                        <i data-feather="download" class="mr-2"></i>Descargar Cupón
                    </a>
                `;
                break;
            case 'transferencia':
                paymentInfo.innerHTML = `
                    <p>Datos para la transferencia:</p>
                    <img src="Datos agencia.jpeg" alt="Datos de transferencia" class="mb-2 max-w-full h-auto">
                    <button onclick="descargarImagenTransferencia()" class="text-blue-600 font-bold py-2 px-4 mt-2 rounded hover:bg-blue-100 transition duration-300 inline-flex items-center">
                        <i data-feather="download" class="mr-2"></i>Descargar Datos de Transferencia
                    </button>
                `;
                break;
            case 'tarjeta':
                const linkPago = 'https://mpago.la/2SHAMqE';
                paymentInfo.innerHTML = `
                    <p>Haga clic en el siguiente enlace para abonar con tarjeta:</p>
                    <a href="${linkPago}" target="_blank" class="text-blue-600 font-bold py-2 px-4 mt-2 rounded hover:bg-blue-100 transition duration-300 inline-flex items-center">
                        <i data-feather="credit-card" class="mr-2"></i>Pagar con tarjeta
                    </a>
                    <button onclick="copiarLinkPago('${linkPago}')" class="bg-white text-blue-600 font-bold py-2 px-4 mt-2 rounded hover:bg-blue-100 transition duration-300 ml-2 inline-flex items-center">
                        <i data-feather="copy" class="mr-2"></i>Copiar Link
                    </button>
                `;
                break;
        }

        feather.replace();

        // Actualizar el vehículo como señado y agregar usuario interesado
        const vehiculoId = getUrlParameter('vehiculo');
        if (vehiculoId) {
            try {
                await supabaseClient
                    .from('clientes')
                    .update({ vehiculo_id: vehiculoId })
                    .eq('numero_documento', formData.get('numeroDocumento'));

                // Agregar usuario interesado
                const nombreCompleto = `${formData.get('nombre')} ${formData.get('apellido')}`;
                await window.agregarUsuarioInteresado(nombreCompleto, vehiculoId);
                
                // Actualizar el contador de usuarios interesados
                await updateInterestedUsersCount(vehiculoId);
            } catch (error) {
                console.error('Error al actualizar el vehículo señado o agregar usuario interesado:', error);
            }
        }
    } catch (error) {
        console.error('Error al enviar el formulario:', error);
        alert('Error al procesar la solicitud. Por favor, intente nuevamente.');
    } finally {
        submitButton.disabled = false;
        submitButton.innerHTML = '<i data-feather="send" class="mr-2"></i>Enviar Formulario';
        feather.replace();
    }
});
    
        // Validation form handler
        document.getElementById('validationForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const numeroDocumento = document.getElementById('codigoValidacion').value;
            const clientInfoContent = document.getElementById('clientInfoContent');
            const clientInfo = document.getElementById('clientInfo');
            const comprobantePagoSection = document.getElementById('comprobantePagoSection');
    
            try {
                const clientData = await window.obtenerDatosCliente(numeroDocumento);
                if (clientData) {
                    // Dividir el nombre_completo en nombre y apellido
                    const [nombre, ...apellidoArray] = clientData.nombre_completo.split(' ');
                    const apellido = apellidoArray.join(' ');
    
                    clientInfoContent.innerHTML = `
                        <p><strong>Nombre:</strong> ${nombre}</p>
                        <p><strong>Apellido:</strong> ${apellido}</p>
                        <p><strong>Documento:</strong> ${clientData.numero_documento}</p>
                        <p><strong>Teléfono:</strong> ${clientData.telefono}</p>
                        <p><strong>Estado:</strong> ${clientData.estado}</p>
                        <p><strong>Fecha de Pago:</strong> ${new Date(clientData.fecha_registro).toLocaleDateString()}</p>
                        <p><strong>Vehículo:</strong> ${clientData.vehiculo_ingreso}</p>
                        <p><strong>Valor cuota:</strong> ${clientData.valor_cuota}</p>
                    `;
                    clientInfo.classList.remove('hidden');
                    
                    if (clientData.estado === 'Aprobada (Pendiente de pago)') {
                        comprobantePagoSection.classList.remove('hidden');
                    } else {
                        comprobantePagoSection.classList.add('hidden');
                    }
                } else {
                    clientInfoContent.innerHTML = '<p>No se encontró información para el número de documento proporcionado.</p>';
                    clientInfo.classList.remove('hidden');
                    comprobantePagoSection.classList.add('hidden');
                }
            } catch (error) {
                console.error('Error al obtener datos del cliente:', error);
                clientInfoContent.innerHTML = '<p>Error al obtener datos del cliente. Por favor, intente nuevamente.</p>';
                clientInfo.classList.remove('hidden');
                comprobantePagoSection.classList.add('hidden');
            }
        });
    
        // Comprobante de pago form handler
        document.getElementById('comprobantePagoForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const numeroDocumento = document.getElementById('codigoValidacion').value;
            const comprobanteFile = document.getElementById('comprobantePago').files[0];
            const enviarComprobanteBtn = document.getElementById('enviarComprobanteBtn');
            
            if (comprobanteFile) {
                try {
                    enviarComprobanteBtn.disabled = true;
                    enviarComprobanteBtn.innerHTML = '<svg class="animate-spin h-5 w-5 mr-3" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Enviando';
    
                    const urlComprobante = await almacenarImagenEnImgBB(comprobanteFile, 'comprobante');
                    const clientData = await window.obtenerDatosCliente(numeroDocumento);
    
                    if (!clientData) {
                        throw new Error('No se encontraron datos del cliente');
                    }
    
                    // Enviar correo electrónico con el comprobante
                    const templateParams = {
                        from_name: "Comprobante de Pago",
                        message: `
                            Número de Documento: ${clientData.numero_documento}
                            Nombre: ${clientData.nombre_completo}
                            URL Comprobante: ${urlComprobante}
                        `,
                        url_comprobante: urlComprobante
                    };
    
                    await emailjs.send("service_jsj4ejn", "template_swfwkp9", templateParams);
    
                    await window.actualizarEstadoCliente(numeroDocumento, 'Comprobante enviado', urlComprobante);
                    
                    alert('Comprobante enviado con éxito. Un asesor se pondrá en contacto para continuar la gestión de la compra.');
                    document.getElementById('validationForm').dispatchEvent(new Event('submit'));
                } catch (error) {
                    console.error('Error al enviar el comprobante:', error);
                    alert('Error al enviar el comprobante. Por favor, intente nuevamente.');
                } finally {
                    enviarComprobanteBtn.disabled = false;
                    enviarComprobanteBtn.innerHTML = '<i data-feather="upload" class="mr-2"></i>Enviar Comprobante';
                    feather.replace();
                }
            } else {
                alert('Por favor, seleccione un archivo de comprobante.');
            }
        });
    
        // Initialize page
        document.addEventListener('DOMContentLoaded', async function() {
            await cargarInformacionVehiculo();
            await verificarVehiculoSenado();
            await updateInterestedUsersCount();
        });
    
        // Helper functions
        function generarCuponPDF(nombreCliente) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Configuración de la página
            doc.setFontSize(12);
            doc.setFont("helvetica", "normal");
    
            // Título
            doc.setFontSize(16);
            doc.setFont("helvetica", "bold");
            doc.text('Cupón de pago', 105, 20, null, null, 'center');
    
            // Subtítulos
            doc.setFontSize(12);
            doc.setFont("helvetica", "normal");
            doc.text('Cupón para múltiples pagos.', 20, 30);
            doc.text('¡Paga las veces que quieras usando este cupón!', 20, 35);
    
            // Instrucciones
            doc.setFontSize(10);
            doc.text('Imprime este cupón de forma legible y conservalo en buen estado. De lo contrario, es', 20, 45);
            doc.text('posible que no puedas hacer el pago.', 20, 50);
    
            // Información del cupón
            doc.setFontSize(12);
            doc.text(`Cupón a nombre de: ${nombreCliente}`, 20, 60);
            doc.text('ID cupón: 20465283', 20, 65);
            doc.text('Para consultar tus pagos realizados,', 20, 70);
            doc.text('debes usar este ID de cupón.', 20, 75);
    
            doc.text('Concepto de pago: Suscripcion', 20, 85);
            doc.text('Referencia: SUS50000', 20, 90);
    
            // Valor a pagar y fecha de validez
            doc.setFontSize(12);
            doc.text('Valor a pagar:', 20, 100);
            doc.text('Cupón válido hasta:', 120, 100);
    
            doc.setFontSize(14);
            doc.setFont("helvetica", "bold");
            doc.text('$ 50,000.00', 20, 110);
            doc.text('13-07-2025', 120, 110);
    
            // Información de la empresa
            doc.setFontSize(10);
            doc.setFont("helvetica", "normal");
            doc.text('Empresa que emite el cupón: MUNDOAUTO MULTIMARCAS S.A.', 20, 120);
            doc.text('Dirección: CORDOBA, Córdoba', 20, 125);
            doc.text('Teléfono: 0351 156141888', 20, 130);
    
            // Información para el pago
            doc.setFontSize(12);
            doc.setFont("helvetica", "bold");
            doc.text('Información para tu pago', 20, 140);
    
            // Código de barras (simulado)
            doc.setFontSize(10);
            doc.setFont("helvetica", "normal");
            doc.text('99581000020465283000000000000000000001307252159000500000038', 20, 150);
    
            // Nota final
            doc.setFontSize(8);
            doc.text('Una vez recibido tu pago, PayU te enviará la confirmación vía email', 20, 160);
            doc.text('Si tienes alguna duda o reclamo, comunícate directamente con MUNDOAUTO', 20, 165);
            doc.text('MULTIMARCAS S.A.', 20, 170);
    
            // Pie de página
            doc.setFontSize(6);
            doc.text('Toda la información se encuentra cifrada para tu privacidad y seguridad. © PayU', 20, 280);
    
            doc.save('cupon_pago_mundoauto.pdf');
        }
    
        function descargarImagenTransferencia() {
            const imagenURL = 'Datos agencia.jpeg';
            const link = document.createElement('a');
            link.href = imagenURL;
            link.download = 'Datos agencia.jpeg';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    
        function copiarLinkPago(link) {
            navigator.clipboard.writeText(link).then(() => {
                alert('Link de pago copiado al portapapeles');
            }).catch(err => {
                console.error('Error al copiar el link: ', err);
            });
        }

        async function loadVehicleCarousel() {
    try {
        // Modificar la consulta para excluir duplicados (donde es_duplicado no es "true" o es NULL)
        const { data, error } = await supabaseClient
            .from('vehiculos')
            .select('*')
            .or('es_duplicado.is.null,es_duplicado.eq.false') // Incluir NULL o valores diferentes a true
            .order('id', { ascending: false })
            //.limit(10);

        if (error) throw error;

        const swiperWrapper = document.querySelector('.swiper-wrapper');
        swiperWrapper.innerHTML = '';

        data.forEach(vehicle => {
            const slide = document.createElement('div');
            slide.className = 'swiper-slide';
            slide.innerHTML = `
                <div class="bg-white rounded-lg shadow-lg overflow-hidden transition-all duration-300 hover:shadow-xl">
                    <img src="${vehicle.fotos[0]}" alt="${vehicle.vehiculo_ingreso}" class="w-full h-56 object-cover">
                    <div class="p-6">
                        <h3 class="text-xl font-semibold mb-2 text-gray-800">${vehicle.vehiculo_ingreso}</h3>
                        <p class="text-sm text-gray-600 mb-4">${vehicle.modelo} - ${vehicle.kilometraje} km</p>
                        <div class="flex justify-between items-center">
                            <span class="text-sm font-medium text-gray-500">Vistas: ${vehicle.views || 0}</span>
                            <button onclick="showVehiclePreview(${vehicle.id})" class="bg-blue-500 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-blue-600 transition duration-300 transform hover:scale-105">Ver más</button>
                        </div>
                    </div>
                </div>
            `;
            swiperWrapper.appendChild(slide);
        });

        // Initialize or update Swiper
        if (window.swiper) {
            window.swiper.destroy();
        }
        window.swiper = new Swiper('.swiper-container', {
            slidesPerView: 1,
            spaceBetween: 20,
            loop: true,
            pagination: {
                el: '.swiper-pagination',
                clickable: true,
            },
            navigation: {
                nextEl: '.swiper-button-next',
                prevEl: '.swiper-button-prev',
            },
            breakpoints: {
                640: {
                    slidesPerView: 2,
                },
                1024: {
                    slidesPerView: 3,
                },
            },
        });
    } catch (error) {
        console.error('Error loading vehicle carousel:', error);
    }
}

// Load the carousel when the page loads
document.addEventListener('DOMContentLoaded', loadVehicleCarousel);


        function getDynamicBanner(interestedUsers) {
            const messages = [
                "¡No pierdas esta oportunidad! Reserva ahora y asegura tu vehículo.",
                "Este vehículo está generando mucho interés. ¡Actúa rápido!",
                "Una oferta que no querrás dejar pasar. ¡Reserva hoy mismo!",
                "Calidad y precio inigualables. ¡Haz tu reserva ahora!",
                "El coche de tus sueños te está esperando. ¡Reserva ya!"
            ];

            if (interestedUsers > 5) {
                return `<div class="dynamic-banner bg-red-600">¡Atención! ${interestedUsers} personas están interesadas en este vehículo. ¡Reserva ahora antes de que sea tarde!</div>`;
            } else {
                const randomMessage = messages[Math.floor(Math.random() * messages.length)];
                return `<div class="dynamic-banner">${randomMessage}</div>`;
            }
        }


async function showVehiclePreview(vehicleId) {
    try {
        const { data: vehicle, error } = await supabaseClient
            .from('vehiculos')
            .select('*')
            .eq('id', vehicleId)
            .single();

        if (error) throw error;

        const { count: interestedUsers, error: countError } = await supabaseClient
            .from('interested_users')
            .select('*', { count: 'exact', head: true })
            .eq('vehiculo_id', vehicleId);

        if (countError) throw countError;

        const dynamicBanner = getDynamicBanner(interestedUsers);

        const previewContent = document.getElementById('previewContent');
        previewContent.innerHTML = `
            ${dynamicBanner}
            <h2>${vehicle.vehiculo_ingreso}</h2>
            <div class="gallery-container">
                ${vehicle.fotos.map(foto => `
                    <img src="${foto}" alt="Imagen del vehículo" class="gallery-image" onclick="openModal('${foto}')">
                `).join('')}
            </div>
            <div class="vehicle-info">
                <div class="info-item">
                    <span class="info-label">Modelo:</span> ${vehicle.modelo}
                </div>
                <div class="info-item">
                    <span class="info-label">Kilometraje:</span> ${vehicle.kilometraje} km
                </div>
                <div class="info-item">
                    <span class="info-label">Ficha Técnica:</span>
                    <p>${vehicle.ficha_tecnica}</p>
                </div>
            </div>
            <button onclick="shareVehicle(${vehicle.id})" class="share-button">
                <i data-feather="share-2"></i>
                Compartir por WhatsApp
            </button>
        `;

        document.getElementById('vehiclePreview').style.display = 'flex';
        feather.replace();
    } catch (error) {
        console.error('Error showing vehicle preview:', error);
    }
}

function getDynamicBanner(interestedUsers) {
    let message = '';
    let color = '';

    if (interestedUsers > 10) {
        message = '¡Este vehículo está generando mucho interés!';
        color = '#FF4136';
    } else if (interestedUsers > 5) {
        message = 'Este vehículo está ganando popularidad';
        color = '#FF851B';
    } else {
        message = 'Sea de los primeros en mostrar interés en este vehículo';
        color = '#2ECC40';
    }

    return `<div class="dynamic-banner" style="background-color: ${color};">${message}</div>`;
}

function openModal(imageSrc) {
    const modal = document.getElementById('imageModal');
    const modalImg = document.getElementById('modalImage');
    modal.style.display = 'block';
    modalImg.src = imageSrc;
}

function shareVehicle(vehicleId) {
    const message = encodeURIComponent(`¡Mira este vehículo! https://yourdomain.com/vehicle/${vehicleId}`);
    window.open(`https://wa.me/?text=${message}`, '_blank');
}

// Close modal when clicking on the close button or outside the modal
window.onclick = function(event) {
    const vehicleModal = document.getElementById('vehiclePreview');
    const imageModal = document.getElementById('imageModal');
    if (event.target == vehicleModal || event.target == imageModal) {
        vehicleModal.style.display = 'none';
        imageModal.style.display = 'none';
    }
}

document.querySelectorAll('.close').forEach(closeBtn => {
    closeBtn.onclick = function() {
        this.parentElement.style.display = 'none';
    }
});

        // Función para abrir el modal con la imagen ampliada
        function openModal(imgSrc) {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            modalImg.src = imgSrc;
        }


        // Function to close vehicle preview
        function closeVehiclePreview() {
            document.getElementById('vehiclePreview').style.display = 'none';
        }

        // Function to share vehicle via WhatsApp
        function shareVehicle(vehicleId) {
            const shareUrl = `${window.location.origin}${window.location.pathname}?vehiculo=${vehicleId}`;
            const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(`¡Mira este vehículo! ${shareUrl}`)}`;
            window.open(whatsappUrl, '_blank');
        }

        // Event listener for closing the preview
        document.querySelector('.close-preview').addEventListener('click', closeVehiclePreview);

        // Load the carousel when the page loads
        document.addEventListener('DOMContentLoaded', loadVehicleCarousel);
    </script>
</body>
</html>
